# ç¯å¢ƒé…ç½®è¯´æ˜

## ä¸‰ä¸ªç¯å¢ƒå®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å½±å“

### 1. æ­£å¼ç¯å¢ƒï¼ˆProductionï¼‰

**è§¦å‘æ¡ä»¶ï¼š** `hostname === 'selfatlas.net' || hostname === 'www.selfatlas.net'`

**é…ç½®ï¼š**
```typescript
API_BASE_URL: '/api'  // ç›¸å¯¹è·¯å¾„
```

**å·¥ä½œæµç¨‹ï¼š**
1. å‰ç«¯è¯·æ±‚ï¼š`/api/psychology/questions`
2. Cloudflare Pages Functions (`functions/api/_middleware.js`) æ‹¦æˆª
3. è½¬å‘åˆ°ï¼š`https://selfatlas-backend-prod.cyberlina.workers.dev/api/psychology/questions`
4. **ä¿ç•™ `/api` å‰ç¼€**

**ä»£ç å¤„ç†ï¼š**
- `buildApiUrl('/psychology/questions')` â†’ `/api/psychology/questions`
- `apiClient.get('/psychology/questions')` â†’ `/api/psychology/questions`
- **ç›¸å¯¹è·¯å¾„ï¼Œç›´æ¥æ‹¼æ¥ï¼Œä¸éœ€è¦ç‰¹æ®Šå¤„ç†**

---

### 2. Staging ç¯å¢ƒ

**è§¦å‘æ¡ä»¶ï¼š** `hostname.includes('pages.dev')`

**é…ç½®ï¼š**
```typescript
API_BASE_URL: '/api'  // ç›¸å¯¹è·¯å¾„
```

**å·¥ä½œæµç¨‹ï¼š**
1. å‰ç«¯è¯·æ±‚ï¼š`/api/psychology/questions`
2. Cloudflare Pages Functions (`functions/api/_middleware.js`) æ‹¦æˆª
3. è½¬å‘åˆ°ï¼š`https://selfatlas-backend-prod.cyberlina.workers.dev/api/psychology/questions`
4. **ä¿ç•™ `/api` å‰ç¼€**

**ä»£ç å¤„ç†ï¼š**
- `buildApiUrl('/psychology/questions')` â†’ `/api/psychology/questions`
- `apiClient.get('/psychology/questions')` â†’ `/api/psychology/questions`
- **ç›¸å¯¹è·¯å¾„ï¼Œç›´æ¥æ‹¼æ¥ï¼Œä¸éœ€è¦ç‰¹æ®Šå¤„ç†**

---

### 3. æœ¬åœ°å¼€å‘ç¯å¢ƒï¼ˆDevelopmentï¼‰

**è§¦å‘æ¡ä»¶ï¼š** `hostname.includes('localhost')`

**é…ç½®ï¼š**
```typescript
API_BASE_URL: 'https://selfatlas-backend-staging.cyberlina.workers.dev'  // å®Œæ•´ URL
```

**å·¥ä½œæµç¨‹ï¼š**
1. å‰ç«¯è¯·æ±‚ï¼š`https://selfatlas-backend-staging.cyberlina.workers.dev/api/psychology/questions`
2. **ç›´æ¥è®¿é—®åç«¯ï¼Œä¸ç»è¿‡ä»£ç†**
3. éœ€è¦æ‰‹åŠ¨æ·»åŠ  `/api` å‰ç¼€

**ä»£ç å¤„ç†ï¼š**
- `buildApiUrl('/psychology/questions')` â†’ `https://.../api/psychology/questions` âœ… **è‡ªåŠ¨æ·»åŠ  `/api`**
- `apiClient.get('/psychology/questions')` â†’ `https://.../api/psychology/questions` âœ… **è‡ªåŠ¨æ·»åŠ  `/api`**
- **å®Œæ•´ URLï¼Œä»£ç è‡ªåŠ¨æ·»åŠ  `/api` å‰ç¼€**

---

## ç‹¬ç«‹æ€§çš„ä¿è¯

### 1. è¿è¡Œæ—¶ç¯å¢ƒåˆ¤æ–­

```typescript
// environment.ts - è¿è¡Œæ—¶æ ¹æ® hostname åŠ¨æ€åˆ¤æ–­
if (hostname === 'selfatlas.net' || hostname === 'www.selfatlas.net') {
  return { API_BASE_URL: '/api' };  // æ­£å¼ç¯å¢ƒ
}
if (hostname.includes('pages.dev')) {
  return { API_BASE_URL: '/api' };  // Staging ç¯å¢ƒ
}
if (hostname.includes('localhost')) {
  return { API_BASE_URL: 'https://...' };  // æœ¬åœ°ç¯å¢ƒ
}
```

**å…³é”®ç‚¹ï¼š** æ¯ä¸ªç¯å¢ƒæ ¹æ® **å®é™…è¿è¡Œçš„åŸŸå** è‡ªåŠ¨é€‰æ‹©é…ç½®ï¼Œä¸ä¼šæ··æ·†ã€‚

### 2. ç»Ÿä¸€çš„ä»£ç å¤„ç†

```typescript
// apiUrlBuilder.ts - æ ¹æ® baseUrl ç±»å‹è‡ªåŠ¨å¤„ç†
if (baseUrl.startsWith('http://') || baseUrl.startsWith('https://')) {
  // å®Œæ•´ URLï¼šè‡ªåŠ¨æ·»åŠ  /api å‰ç¼€
  return `${baseUrl}/api${normalizedEndpoint}`;
} else {
  // ç›¸å¯¹è·¯å¾„ï¼šç›´æ¥æ‹¼æ¥
  return `${baseUrl}${normalizedEndpoint}`;
}
```

**å…³é”®ç‚¹ï¼š** ä»£ç è‡ªåŠ¨è¯†åˆ« URL ç±»å‹ï¼Œé‡‡ç”¨æ­£ç¡®çš„å¤„ç†æ–¹å¼ã€‚

### 3. apiClient çš„ç»Ÿä¸€å¤„ç†

```typescript
// apiClient.ts - è‡ªåŠ¨æ·»åŠ  /api å‰ç¼€ï¼ˆå¦‚æœæ˜¯å®Œæ•´ URLï¼‰
if ((this.baseURL.startsWith('http://') || this.baseURL.startsWith('https://')) 
    && !normalizedEndpoint.startsWith('/api')) {
  normalizedEndpoint = `/api${normalizedEndpoint}`;
}
```

**å…³é”®ç‚¹ï¼š** `apiClient` ä¹Ÿä¼šè‡ªåŠ¨å¤„ç†å®Œæ•´ URL çš„æƒ…å†µã€‚

---

## æ€»ç»“

| ç¯å¢ƒ | API_BASE_URL | å¤„ç†æ–¹å¼ | ä»£ç† |
|------|-------------|---------|------|
| **æ­£å¼ç¯å¢ƒ** | `/api` | ç›¸å¯¹è·¯å¾„ï¼Œç›´æ¥æ‹¼æ¥ | Cloudflare Pages Functions |
| **Staging ç¯å¢ƒ** | `/api` | ç›¸å¯¹è·¯å¾„ï¼Œç›´æ¥æ‹¼æ¥ | Cloudflare Pages Functions |
| **æœ¬åœ°ç¯å¢ƒ** | `https://...` | å®Œæ•´ URLï¼Œä»£ç è‡ªåŠ¨æ·»åŠ  `/api` | æ— ï¼ˆç›´æ¥è®¿é—®ï¼‰ |

### âœ… ç›¸äº’ç‹¬ç«‹çš„åŸå› ï¼š

1. **ç¯å¢ƒåˆ¤æ–­åŸºäºåŸŸå** - è¿è¡Œæ—¶æ ¹æ®å®é™…è®¿é—®çš„åŸŸåè‡ªåŠ¨é€‰æ‹©é…ç½®
2. **ä»£ç è‡ªåŠ¨é€‚é…** - `buildApiUrl()` å’Œ `apiClient` æ ¹æ® URL ç±»å‹è‡ªåŠ¨å¤„ç†
3. **é…ç½®å®Œå…¨éš”ç¦»** - ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒçš„ `API_BASE_URL`ï¼Œä¸ä¼šäº’ç›¸å½±å“

### ğŸ¯ å®é™…æ•ˆæœï¼š

- **æ­£å¼ç¯å¢ƒ**ï¼šéƒ¨ç½²åè‡ªåŠ¨ä½¿ç”¨ `/api`ï¼Œé€šè¿‡ Pages Functions ä»£ç† âœ…
- **Staging ç¯å¢ƒ**ï¼šéƒ¨ç½²åè‡ªåŠ¨ä½¿ç”¨ `/api`ï¼Œé€šè¿‡ Pages Functions ä»£ç† âœ…
- **æœ¬åœ°ç¯å¢ƒ**ï¼šè¿è¡Œæ—¶è‡ªåŠ¨ä½¿ç”¨å®Œæ•´ URLï¼Œä»£ç è‡ªåŠ¨æ·»åŠ  `/api` âœ…

**ç»“è®ºï¼šä¸‰ä¸ªç¯å¢ƒå®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å½±å“ï¼** ğŸ‰

